<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGB Color Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a24;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.08);
            --success: #22c55e;
            --error: #ef4444;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        /* Layout */
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #ef4444, #22c55e, #3b82f6);
            border-radius: 10px;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .current-color {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-elevated);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .current-color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .current-color-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border);
            overflow: hidden;
        }

        @media (max-width: 900px) {
            .main {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
        }

        .panel {
            background: var(--bg-dark);
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .panel-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        /* Explorer Panel */
        .stage-wrapper {
            flex: 1;
            display: flex;
            gap: 1.5rem;
            min-height: 280px;
            max-height: 400px;
        }

        .sliders {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 0.5rem 0;
        }

        .slider-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .slider-label {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .slider-label.red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .slider-label.green { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .slider-label.blue { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }

        .slider-track {
            position: relative;
            width: 8px;
            height: 100px;
            background: var(--bg-elevated);
            border-radius: 4px;
            cursor: pointer;
        }

        .slider-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            border-radius: 4px;
            transition: height 0.05s ease;
        }

        .slider-fill.red { background: linear-gradient(to top, #7f1d1d, #ef4444); }
        .slider-fill.green { background: linear-gradient(to top, #14532d, #22c55e); }
        .slider-fill.blue { background: linear-gradient(to top, #1e3a8a, #3b82f6); }

        .slider-thumb {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: transform 0.1s ease;
        }

        .slider-thumb:hover {
            transform: translateX(-50%) scale(1.15);
        }

        .slider-thumb:active {
            cursor: grabbing;
        }

        .slider-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 28px;
            text-align: center;
        }

        .stage {
            flex: 1;
            position: relative;
            background: radial-gradient(ellipse at center, #0f0f18 0%, #000 100%);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        #spotlightCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Result Section */
        .result-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.25rem;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .result-swatch {
            width: 72px;
            height: 72px;
            border-radius: 14px;
            border: 3px solid var(--border);
            box-shadow: 0 0 30px var(--accent-glow);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .result-hex {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .result-rgb {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--accent-glow);
        }

        .btn-ghost {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* Palette Panel */
        .input-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .hex-input {
            flex: 1;
            min-width: 100px;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .hex-input:focus {
            border-color: var(--accent-primary);
        }

        .color-picker-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            background: none;
        }

        .color-picker-btn input {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            cursor: pointer;
            border: none;
        }

        /* Harmony Tabs */
        .harmony-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .harmony-tab {
            padding: 0.5rem 0.875rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .harmony-tab:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .harmony-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* Swatches */
        .swatches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 0.75rem;
        }

        .swatch {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .swatch:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }

        .swatch-color {
            height: 56px;
            transition: background-color 0.3s ease;
        }

        .swatch-info {
            padding: 0.5rem 0.625rem;
        }

        .swatch-hex {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.125rem;
        }

        .swatch-name {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: capitalize;
        }

        /* Preview Card */
        .preview-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .preview-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .preview-content {
            padding: 1.25rem;
            border-radius: 8px;
            margin: 0.75rem;
            transition: all 0.3s ease;
        }

        .preview-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .preview-text {
            font-size: 0.8rem;
            opacity: 0.85;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .preview-button {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Accessibility Section */
        .accordion {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .accordion-header:hover {
            background: var(--bg-elevated);
        }

        .accordion-title {
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .accordion-icon {
            transition: transform 0.3s ease;
            color: var(--text-muted);
        }

        .accordion.open .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion.open .accordion-content {
            max-height: 600px;
        }

        .accordion-inner {
            padding: 0 1rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .tool-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .tool-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent-primary);
        }

        /* Contrast Checker */
        .contrast-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .contrast-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .contrast-input input[type="color"] {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: none;
        }

        .contrast-input input[type="text"] {
            width: 75px;
            padding: 0.4rem 0.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }

        .contrast-result {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .contrast-ratio {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .contrast-badges {
            display: flex;
            gap: 0.375rem;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .badge.pass {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .badge.fail {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        /* Color Blindness */
        .cb-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .cb-btn {
            padding: 0.4rem 0.75rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cb-btn:hover {
            border-color: var(--accent-primary);
        }

        .cb-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .simulated-swatches {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .sim-swatch {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        /* Toggle */
        .toggle-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle {
            width: 44px;
            height: 24px;
            background: var(--bg-elevated);
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s ease;
            border: 1px solid var(--border);
            flex-shrink: 0;
        }

        .toggle.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        .toggle.active::after {
            transform: translateX(20px);
        }

        .toggle-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--accent-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">
                <div class="logo-icon"></div>
                <span class="logo-text">RGB Color Studio</span>
            </div>
            <div class="current-color">
                <div class="current-color-swatch" id="headerSwatch"></div>
                <span class="current-color-value" id="headerHex">#FFFFFF</span>
            </div>
        </header>

        <main class="main">
            <!-- Explorer Panel -->
            <div class="panel">
                <div class="panel-title">Light Mixer</div>

                <div class="stage-wrapper">
                    <div class="sliders">
                        <div class="slider-item">
                            <div class="slider-label red">R</div>
                            <div class="slider-track" data-color="red">
                                <div class="slider-fill red" id="redFill"></div>
                                <div class="slider-thumb" id="redThumb"></div>
                            </div>
                            <div class="slider-value" id="redValue">255</div>
                        </div>
                        <div class="slider-item">
                            <div class="slider-label green">G</div>
                            <div class="slider-track" data-color="green">
                                <div class="slider-fill green" id="greenFill"></div>
                                <div class="slider-thumb" id="greenThumb"></div>
                            </div>
                            <div class="slider-value" id="greenValue">128</div>
                        </div>
                        <div class="slider-item">
                            <div class="slider-label blue">B</div>
                            <div class="slider-track" data-color="blue">
                                <div class="slider-fill blue" id="blueFill"></div>
                                <div class="slider-thumb" id="blueThumb"></div>
                            </div>
                            <div class="slider-value" id="blueValue">64</div>
                        </div>
                    </div>

                    <div class="stage">
                        <canvas id="spotlightCanvas"></canvas>
                    </div>
                </div>

                <div class="result-section">
                    <div class="result-swatch" id="resultSwatch"></div>
                    <div class="result-info">
                        <div class="result-hex" id="resultHex">#FF8040</div>
                        <div class="result-rgb" id="resultRgb">rgb(255, 128, 64)</div>
                    </div>
                    <button class="btn btn-primary" id="sendToPalette">Use in Palette</button>
                </div>
            </div>

            <!-- Palette Panel -->
            <div class="panel">
                <div class="panel-title">Palette Generator</div>

                <div class="input-row">
                    <input type="text" class="hex-input" id="hexInput" placeholder="#FF8040" maxlength="7">
                    <div class="color-picker-btn">
                        <input type="color" id="colorPicker" value="#ff8040">
                    </div>
                    <button class="btn btn-ghost" id="randomBtn">Randomize</button>
                </div>

                <div class="harmony-tabs">
                    <button class="harmony-tab active" data-type="complementary">Complementary</button>
                    <button class="harmony-tab" data-type="analogous">Analogous</button>
                    <button class="harmony-tab" data-type="triadic">Triadic</button>
                    <button class="harmony-tab" data-type="split">Split-Comp</button>
                    <button class="harmony-tab" data-type="tetradic">Tetradic</button>
                </div>

                <div class="swatches-grid" id="swatches"></div>

                <div class="preview-card">
                    <div class="preview-header">UI Preview</div>
                    <div class="preview-content" id="previewContent">
                        <div class="preview-title">Welcome Back</div>
                        <div class="preview-text">See how your palette looks in a real interface design.</div>
                        <span class="preview-button">Get Started</span>
                    </div>
                </div>

                <div class="accordion" id="accessibilityAccordion">
                    <div class="accordion-header">
                        <span class="accordion-title">
                            <svg class="accordion-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6,9 12,15 18,9"></polyline>
                            </svg>
                            Accessibility Tools
                        </span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-inner">
                            <div class="tool-section">
                                <div class="tool-label">Contrast Checker</div>
                                <div class="contrast-row">
                                    <div class="contrast-input">
                                        <input type="color" id="contrast1" value="#ffffff">
                                        <input type="text" id="contrastHex1" value="#FFFFFF">
                                    </div>
                                    <span style="color: var(--text-muted); font-size: 0.8rem;">vs</span>
                                    <div class="contrast-input">
                                        <input type="color" id="contrast2" value="#000000">
                                        <input type="text" id="contrastHex2" value="#000000">
                                    </div>
                                </div>
                                <div class="contrast-result">
                                    <span class="contrast-ratio" id="contrastRatio">21:1</span>
                                    <div class="contrast-badges" id="contrastBadges"></div>
                                </div>
                            </div>

                            <div class="tool-section">
                                <div class="tool-label">Color Blindness Preview</div>
                                <div class="cb-buttons">
                                    <button class="cb-btn active" data-type="normal">Normal</button>
                                    <button class="cb-btn" data-type="protanopia">Protanopia</button>
                                    <button class="cb-btn" data-type="deuteranopia">Deuteranopia</button>
                                    <button class="cb-btn" data-type="tritanopia">Tritanopia</button>
                                </div>
                                <div class="simulated-swatches" id="simSwatches"></div>
                            </div>

                            <div class="tool-section">
                                <div class="tool-label">Accessible Mode</div>
                                <div class="toggle-row">
                                    <div class="toggle" id="accessibleToggle"></div>
                                    <span class="toggle-label">Enforce 4.5:1 contrast ratio</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast" id="toast">Copied!</div>

    <script>
        // ============ Color Utilities ============
        const rgbToHex = (r, g, b) => '#' + [r, g, b].map(x => Math.round(Math.min(255, Math.max(0, x))).toString(16).padStart(2, '0')).join('').toUpperCase();

        const hexToRgb = hex => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        };

        const rgbToHsl = (r, g, b) => {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; }
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return { h: h * 360, s: s * 100, l: l * 100 };
        };

        const hslToRgb = (h, s, l) => {
            h /= 360; s /= 100; l /= 100;
            let r, g, b;
            if (s === 0) { r = g = b = l; }
            else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
        };

        const getColorName = (h, s, l) => {
            if (s < 10) return l < 20 ? 'Black' : l > 80 ? 'White' : 'Gray';
            const names = [[15, 'Red'], [45, 'Orange'], [75, 'Yellow'], [105, 'Lime'], [135, 'Green'],
                          [165, 'Teal'], [195, 'Cyan'], [225, 'Sky'], [255, 'Blue'], [285, 'Purple'],
                          [315, 'Magenta'], [345, 'Rose'], [360, 'Red']];
            let name = 'Color';
            for (let i = 0; i < names.length - 1; i++) {
                if (h < names[i][0]) { name = i === 0 ? 'Red' : names[i-1][1]; break; }
                name = names[i][1];
            }
            return (l < 35 ? 'Dark ' : l > 65 ? 'Light ' : '') + name;
        };

        // ============ Contrast & Accessibility ============
        const getLuminance = (r, g, b) => {
            const [rs, gs, bs] = [r, g, b].map(c => {
                c /= 255;
                return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
            });
            return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
        };

        const getContrastRatio = (c1, c2) => {
            const l1 = getLuminance(c1.r, c1.g, c1.b);
            const l2 = getLuminance(c2.r, c2.g, c2.b);
            return (Math.max(l1, l2) + 0.05) / (Math.min(l1, l2) + 0.05);
        };

        const cbMatrices = {
            protanopia: [[0.567, 0.433, 0], [0.558, 0.442, 0], [0, 0.242, 0.758]],
            deuteranopia: [[0.625, 0.375, 0], [0.7, 0.3, 0], [0, 0.3, 0.7]],
            tritanopia: [[0.95, 0.05, 0], [0, 0.433, 0.567], [0, 0.475, 0.525]]
        };

        const simulateCB = (rgb, type) => {
            if (type === 'normal') return rgb;
            const m = cbMatrices[type];
            return {
                r: Math.min(255, Math.max(0, Math.round(m[0][0] * rgb.r + m[0][1] * rgb.g + m[0][2] * rgb.b))),
                g: Math.min(255, Math.max(0, Math.round(m[1][0] * rgb.r + m[1][1] * rgb.g + m[1][2] * rgb.b))),
                b: Math.min(255, Math.max(0, Math.round(m[2][0] * rgb.r + m[2][1] * rgb.g + m[2][2] * rgb.b)))
            };
        };

        // ============ Palette Generation ============
        const generatePalette = (base, type) => {
            const hsl = rgbToHsl(base.r, base.g, base.b);
            let angles;
            switch (type) {
                case 'complementary': angles = [0, 180]; break;
                case 'analogous': angles = [-30, 0, 30]; break;
                case 'triadic': angles = [0, 120, 240]; break;
                case 'split': angles = [0, 150, 210]; break;
                case 'tetradic': angles = [0, 90, 180, 270]; break;
                default: angles = [0];
            }
            return angles.map(a => {
                const h = (hsl.h + a + 360) % 360;
                const rgb = hslToRgb(h, hsl.s, hsl.l);
                return { ...rgb, hex: rgbToHex(rgb.r, rgb.g, rgb.b), name: getColorName(h, hsl.s, hsl.l) };
            });
        };

        // ============ State ============
        let state = {
            r: 255, g: 128, b: 64,
            palette: [],
            harmonyType: 'complementary',
            cbType: 'normal',
            accessibleMode: false
        };

        let spotlights = [
            { x: 0.25, y: 0.3 },
            { x: 0.5, y: 0.65 },
            { x: 0.75, y: 0.35 }
        ];

        let draggedSpot = null;
        let canvasWidth = 0;
        let canvasHeight = 0;

        // ============ Canvas ============
        const canvas = document.getElementById('spotlightCanvas');
        const ctx = canvas.getContext('2d');
        const stage = canvas.parentElement;

        const resizeCanvas = () => {
            const rect = stage.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvasWidth = rect.width;
            canvasHeight = rect.height;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        };

        const drawSpotlights = () => {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            ctx.globalCompositeOperation = 'screen';

            const colors = [
                { r: state.r, g: 0, b: 0 },
                { r: 0, g: state.g, b: 0 },
                { r: 0, g: 0, b: state.b }
            ];

            spotlights.forEach((spot, i) => {
                const x = spot.x * canvasWidth;
                const y = spot.y * canvasHeight;
                const intensity = [state.r, state.g, state.b][i] / 255;
                const radius = Math.min(canvasWidth, canvasHeight) * 0.35 * Math.max(0.1, intensity);

                const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
                const c = colors[i];
                gradient.addColorStop(0, `rgba(${c.r}, ${c.g}, ${c.b}, 1)`);
                gradient.addColorStop(0.4, `rgba(${c.r}, ${c.g}, ${c.b}, 0.6)`);
                gradient.addColorStop(1, 'transparent');

                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
            });
        };

        // ============ UI Updates ============
        const updateSliders = () => {
            ['red', 'green', 'blue'].forEach((c, i) => {
                const val = [state.r, state.g, state.b][i];
                const pct = val / 255 * 100;
                document.getElementById(`${c}Fill`).style.height = pct + '%';
                document.getElementById(`${c}Thumb`).style.bottom = `calc(${pct}% - 10px)`;
                document.getElementById(`${c}Value`).textContent = val;
            });
        };

        const updateDisplay = () => {
            const hex = rgbToHex(state.r, state.g, state.b);
            document.getElementById('resultSwatch').style.backgroundColor = hex;
            document.getElementById('resultHex').textContent = hex;
            document.getElementById('resultRgb').textContent = `rgb(${state.r}, ${state.g}, ${state.b})`;
            document.getElementById('headerSwatch').style.backgroundColor = hex;
            document.getElementById('headerHex').textContent = hex;
        };

        const updatePalette = () => {
            const hex = document.getElementById('hexInput').value || '#FF8040';
            const rgb = hexToRgb(hex);
            if (!rgb) return;

            state.palette = generatePalette(rgb, state.harmonyType);
            renderSwatches();
            updatePreview();
            updateContrast();
            updateCBSimulation();
        };

        const renderSwatches = () => {
            const container = document.getElementById('swatches');
            container.innerHTML = state.palette.map((c, i) => `
                <div class="swatch" data-hex="${c.hex}">
                    <div class="swatch-color" style="background: ${c.hex}"></div>
                    <div class="swatch-info">
                        <div class="swatch-hex">${c.hex}</div>
                        <div class="swatch-name">${c.name}</div>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.swatch').forEach(s => {
                s.addEventListener('click', () => {
                    navigator.clipboard.writeText(s.dataset.hex);
                    showToast('Copied ' + s.dataset.hex);
                });
            });
        };

        const updatePreview = () => {
            if (state.palette.length < 2) return;
            const preview = document.getElementById('previewContent');
            const bg = state.palette[0];
            const text = state.palette[1];

            preview.style.backgroundColor = bg.hex;
            preview.querySelector('.preview-title').style.color = text.hex;
            preview.querySelector('.preview-text').style.color = text.hex;
            const button = preview.querySelector('.preview-button');
            button.style.backgroundColor = text.hex;
            button.style.color = bg.hex;
        };

        const updateContrast = () => {
            const hex1 = document.getElementById('contrastHex1').value;
            const hex2 = document.getElementById('contrastHex2').value;
            const c1 = hexToRgb(hex1), c2 = hexToRgb(hex2);
            if (!c1 || !c2) return;

            const ratio = getContrastRatio(c1, c2);
            document.getElementById('contrastRatio').textContent = ratio.toFixed(2) + ':1';
            document.getElementById('contrastBadges').innerHTML = [
                ['AA', 4.5], ['AA Large', 3], ['AAA', 7], ['AAA Large', 4.5]
            ].map(([label, min]) =>
                `<span class="badge ${ratio >= min ? 'pass' : 'fail'}">${label} ${ratio >= min ? '✓' : '✗'}</span>`
            ).join('');
        };

        const updateCBSimulation = () => {
            const container = document.getElementById('simSwatches');
            container.innerHTML = state.palette.map(c => {
                const sim = simulateCB(c, state.cbType);
                return `<div class="sim-swatch" style="background: ${rgbToHex(sim.r, sim.g, sim.b)}" title="${c.hex}"></div>`;
            }).join('');
        };

        const showToast = msg => {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        };

        // ============ Event Handlers ============
        // Sliders
        document.querySelectorAll('.slider-track').forEach(track => {
            const color = track.dataset.color;

            const updateFromY = (y, rect) => {
                const pct = Math.max(0, Math.min(1, 1 - (y - rect.top) / rect.height));
                const val = Math.round(pct * 255);
                if (color === 'red') state.r = val;
                else if (color === 'green') state.g = val;
                else state.b = val;
                updateSliders();
                updateDisplay();
                drawSpotlights();
            };

            const onMove = e => {
                e.preventDefault();
                const rect = track.getBoundingClientRect();
                const y = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                updateFromY(y, rect);
            };

            const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('touchend', onUp);
            };

            track.addEventListener('mousedown', e => {
                onMove(e);
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });

            track.addEventListener('touchstart', e => {
                onMove(e);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onUp);
            }, { passive: false });
        });

        // Canvas dragging
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;

            spotlights.forEach((s, i) => {
                if (Math.hypot(x - s.x, y - s.y) < 0.12) draggedSpot = i;
            });
        });

        canvas.addEventListener('mousemove', e => {
            if (draggedSpot === null) return;
            const rect = canvas.getBoundingClientRect();
            spotlights[draggedSpot].x = Math.max(0.1, Math.min(0.9, (e.clientX - rect.left) / rect.width));
            spotlights[draggedSpot].y = Math.max(0.1, Math.min(0.9, (e.clientY - rect.top) / rect.height));
            drawSpotlights();
        });

        canvas.addEventListener('mouseup', () => draggedSpot = null);
        canvas.addEventListener('mouseleave', () => draggedSpot = null);

        // Send to palette
        document.getElementById('sendToPalette').addEventListener('click', () => {
            const hex = rgbToHex(state.r, state.g, state.b);
            document.getElementById('hexInput').value = hex;
            document.getElementById('colorPicker').value = hex.toLowerCase();
            updatePalette();
            showToast('Color sent to palette');
        });

        // Hex input
        document.getElementById('hexInput').addEventListener('input', e => {
            let v = e.target.value;
            if (!v.startsWith('#')) v = '#' + v;
            if (/^#[0-9A-Fa-f]{6}$/.test(v)) {
                document.getElementById('colorPicker').value = v.toLowerCase();
                updatePalette();
            }
        });

        // Color picker
        document.getElementById('colorPicker').addEventListener('input', e => {
            document.getElementById('hexInput').value = e.target.value.toUpperCase();
            updatePalette();
        });

        // Randomize
        document.getElementById('randomBtn').addEventListener('click', () => {
            const h = Math.random() * 360;
            const s = 50 + Math.random() * 40;
            const l = 40 + Math.random() * 25;
            const rgb = hslToRgb(h, s, l);
            const hex = rgbToHex(rgb.r, rgb.g, rgb.b);
            document.getElementById('hexInput').value = hex;
            document.getElementById('colorPicker').value = hex.toLowerCase();
            updatePalette();
        });

        // Harmony tabs
        document.querySelectorAll('.harmony-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.harmony-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                state.harmonyType = tab.dataset.type;
                updatePalette();
            });
        });

        // Accordion
        document.getElementById('accessibilityAccordion').querySelector('.accordion-header').addEventListener('click', () => {
            document.getElementById('accessibilityAccordion').classList.toggle('open');
        });

        // Contrast inputs
        ['contrast1', 'contrast2'].forEach((id, i) => {
            document.getElementById(id).addEventListener('input', e => {
                document.getElementById(`contrastHex${i + 1}`).value = e.target.value.toUpperCase();
                updateContrast();
            });
        });

        ['contrastHex1', 'contrastHex2'].forEach((id, i) => {
            document.getElementById(id).addEventListener('input', e => {
                if (/^#[0-9A-Fa-f]{6}$/i.test(e.target.value)) {
                    document.getElementById(`contrast${i + 1}`).value = e.target.value.toLowerCase();
                    updateContrast();
                }
            });
        });

        // Color blindness buttons
        document.querySelectorAll('.cb-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.cb-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.cbType = btn.dataset.type;
                updateCBSimulation();
            });
        });

        // Accessible toggle
        document.getElementById('accessibleToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            state.accessibleMode = this.classList.contains('active');
        });

        // ============ Init ============
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                resizeCanvas();
                drawSpotlights();
            }, 100);
        });

        // Initial setup
        resizeCanvas();
        updateSliders();
        updateDisplay();
        drawSpotlights();
        document.getElementById('hexInput').value = '#FF8040';
        document.getElementById('colorPicker').value = '#ff8040';
        updatePalette();
        updateContrast();
    </script>
</body>
</html>
